server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml  # Tracks log positions

clients:
  - url: http://loki:3100/loki/api/v1/push  # Send logs to Loki
    timeout: 10s


scrape_configs:
  # --------------------------
  # 1️⃣ Collect Docker Logs (All Containers)
  # --------------------------
  - job_name: "docker-logs"
    pipeline_stages:
      - json:
          expressions:
            log: log
            stream: stream
            time: time

    docker_sd_configs:
      - host: unix:///var/run/docker.sock  # ✅ Access Docker API
        refresh_interval: 10s

    relabel_configs:
      - source_labels: [__meta_docker_container_id]
        target_label: container_id

      - source_labels: [__meta_docker_container_name]
        target_label: container_name

      - source_labels: [__meta_docker_container_label_com_docker_compose_service]
        target_label: service_name

      - source_labels: [stream]
        target_label: log_stream

  # --------------------------
  # 2️⃣ Collect System Logs (Separate Jobs for Each Log)
  # --------------------------

  - job_name: "auth-log"
    static_configs:
      - targets:
          - localhost
        labels:
          job: "auth-log"
          __path__: "/var/log/auth.log"

  - job_name: "syslog"
    static_configs:
      - targets:
          - localhost
        labels:
          job: "syslog"
          __path__: "/var/log/syslog"

  - job_name: "kern-log"
    static_configs:
      - targets:
          - localhost
        labels:
          job: "kern-log"
          __path__: "/var/log/kern.log"

